<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý khách hàng - Mihn Cosmetics</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Outfit:wght@600;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/admin.css">
</head>

<body>
    <div class="admin-layout">
        <!-- Sidebar -->
        <aside class="admin-sidebar">
            <div class="admin-logo">
                <div class="admin-logo-icon">
                    M
                </div>
                <span>Mihn Cosmetics</span>
            </div>

            <nav class="admin-nav">
                <a href="dashboard.html" class="admin-nav-link">
                    <i class="fas fa-chart-pie"></i>
                    <span>Dashboard</span>
                </a>
                <a href="products.html" class="admin-nav-link">
                    <i class="fas fa-box"></i>
                    <span>Sản phẩm</span>
                </a>
                <a href="categories.html" class="admin-nav-link">
                    <i class="fas fa-tags"></i>
                    <span>Danh mục</span>
                </a>
                <a href="coupons.html" class="admin-nav-link">
                    <i class="fas fa-ticket"></i>
                    <span>Mã giảm giá</span>
                </a>
                <a href="batches.html" class="admin-nav-link">
                    <i class="fas fa-layer-group"></i>
                    <span>Lô hàng</span>
                </a>
                <a href="orders.html" class="admin-nav-link">
                    <i class="fas fa-shopping-cart"></i>
                    <span>Đơn hàng</span>
                </a>
                <a href="customers.html" class="admin-nav-link active">
                    <i class="fas fa-users"></i>
                    <span>Khách hàng</span>
                </a>
                <a href="../index.html" class="admin-nav-link" style="margin-top: auto;">
                    <i class="fas fa-store"></i>
                    <span>Xem cửa hàng</span>
                </a>
                <a href="#" class="admin-nav-link" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Đăng xuất</span>
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="admin-main">
            <header class="admin-header">
                <h1 class="admin-page-title">Quản lý khách hàng</h1>
                <div class="admin-user">
                    <span id="adminName">Admin</span>
                    <div class="admin-avatar">A</div>
                </div>
            </header>

            <div class="admin-content">
                <!-- Stats Cards -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon primary">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="totalCustomers">-</h3>
                            <p>Tổng khách hàng</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon success">
                            <i class="fas fa-user-plus"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="newThisMonth">-</h3>
                            <p>Khách mới tháng này</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon warning">
                            <i class="fas fa-crown"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="topSpenderName">-</h3>
                            <p>Top khách hàng</p>
                        </div>
                    </div>
                </div>

                <!-- Search and Filter -->
                <div class="admin-table-card">
                    <div class="admin-table-header">
                        <h3 class="admin-table-title">Danh sách khách hàng</h3>
                        <div class="search-bar" style="max-width: 300px;">
                            <input type="text" placeholder="Tìm theo tên, email, SĐT..." id="searchInput">
                            <button class="btn btn-primary btn-sm" onclick="handleSearch()">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Customers Table -->
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Tên khách hàng</th>
                                <th>Email</th>
                                <th>Số điện thoại</th>
                                <th>Số đơn hàng</th>
                                <th>Tổng chi tiêu</th>
                                <th>Ngày đăng ký</th>
                                <th>Hành động</th>
                            </tr>
                        </thead>
                        <tbody id="customersTableBody">
                            <tr>
                                <td colspan="8" style="text-align: center; padding: 2rem;">
                                    <div class="spinner" style="margin: 0 auto;"></div>
                                </td>
                            </tr>
                        </tbody>
                    </table>

                    <!-- Pagination -->
                    <div class="pagination" id="pagination"
                        style="margin-top: 1rem; display: flex; justify-content: center; gap: 0.5rem;">
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Customer Detail Modal -->
    <div class="modal-overlay" id="customerModal" style="display: none;">
        <div class="modal" style="max-width: 700px;">
            <div class="modal-header">
                <h3>Chi tiết khách hàng</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="customerModalBody">
                <div class="spinner" style="margin: 2rem auto;"></div>
            </div>
        </div>
    </div>

    <div class="toast-container"></div>

    <script src="../js/api.js"></script>
    <script>
        let currentPage = 1;
        let searchQuery = '';

        const statusLabels = {
            pending: { text: 'Chờ xác nhận', class: 'status-pending' },
            confirmed: { text: 'Đã xác nhận', class: 'status-confirmed' },
            shipping: { text: 'Đang giao', class: 'status-shipping' },
            delivered: { text: 'Đã giao', class: 'status-delivered' },
            cancelled: { text: 'Đã hủy', class: 'status-cancelled' }
        };

        // Check admin access
        if (!Utils.isLoggedIn() || !Utils.isAdmin()) {
            window.location.href = '../login.html';
        }

        // Load page data
        async function loadPage() {
            const user = Utils.getUser();
            document.getElementById('adminName').textContent = user?.name || 'Admin';

            await Promise.all([
                loadStats(),
                loadCustomers()
            ]);
        }

        // Load customer statistics
        async function loadStats() {
            try {
                const response = await API.customers.getStats();
                if (response.success) {
                    const data = response.data;
                    document.getElementById('totalCustomers').textContent = data.total_customers;
                    document.getElementById('newThisMonth').textContent = data.new_this_month;

                    if (data.top_spenders && data.top_spenders.length > 0) {
                        document.getElementById('topSpenderName').textContent = data.top_spenders[0].name;
                    }
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // Load customers list
        async function loadCustomers() {
            try {
                const response = await API.customers.getAll({
                    search: searchQuery,
                    page: currentPage,
                    limit: 10
                });

                if (response.success) {
                    renderCustomers(response.data.customers);
                    renderPagination(response.data);
                }
            } catch (error) {
                console.error('Error loading customers:', error);
                Utils.showToast('Không thể tải danh sách khách hàng', 'error');
            }
        }

        // Render customers table
        function renderCustomers(customers) {
            const tbody = document.getElementById('customersTableBody');

            if (customers.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 2rem; color: var(--gray-500);">
                            Không tìm thấy khách hàng nào
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = customers.map(customer => `
                <tr>
                    <td><strong>#${customer.id}</strong></td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <div class="avatar" style="width: 36px; height: 36px; border-radius: 50%; background: linear-gradient(135deg, var(--primary-400), var(--primary-600)); color: white; display: flex; align-items: center; justify-content: center; font-weight: 600;">
                                ${customer.name.charAt(0).toUpperCase()}
                            </div>
                            <span>${customer.name}</span>
                        </div>
                    </td>
                    <td>${customer.email}</td>
                    <td>${customer.phone || '-'}</td>
                    <td><span class="badge badge-info">${customer.total_orders}</span></td>
                    <td><strong style="color: var(--success);">${Utils.formatCurrency(customer.total_spent)}</strong></td>
                    <td>${Utils.formatDate(customer.created_at)}</td>
                    <td>
                        <button class="action-btn view" onclick="viewCustomer(${customer.id})" title="Xem chi tiết">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Render pagination
        function renderPagination(data) {
            const container = document.getElementById('pagination');

            if (data.totalPages <= 1) {
                container.innerHTML = '';
                return;
            }

            let html = '';

            // Previous button
            if (currentPage > 1) {
                html += `<button class="btn btn-secondary btn-sm" onclick="goToPage(${currentPage - 1})"><i class="fas fa-chevron-left"></i></button>`;
            }

            // Page numbers
            for (let i = 1; i <= data.totalPages; i++) {
                if (i === currentPage) {
                    html += `<button class="btn btn-primary btn-sm">${i}</button>`;
                } else {
                    html += `<button class="btn btn-secondary btn-sm" onclick="goToPage(${i})">${i}</button>`;
                }
            }

            // Next button
            if (currentPage < data.totalPages) {
                html += `<button class="btn btn-secondary btn-sm" onclick="goToPage(${currentPage + 1})"><i class="fas fa-chevron-right"></i></button>`;
            }

            container.innerHTML = html;
        }

        // Go to page
        function goToPage(page) {
            currentPage = page;
            loadCustomers();
        }

        // Handle search
        function handleSearch() {
            searchQuery = document.getElementById('searchInput').value.trim();
            currentPage = 1;
            loadCustomers();
        }

        // Search on Enter
        document.getElementById('searchInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleSearch();
        });

        // View customer details
        async function viewCustomer(id) {
            const modal = document.getElementById('customerModal');
            const modalBody = document.getElementById('customerModalBody');

            modal.style.display = 'flex';
            modalBody.innerHTML = '<div class="spinner" style="margin: 2rem auto;"></div>';

            try {
                const [customerRes, ordersRes] = await Promise.all([
                    API.customers.getById(id),
                    API.customers.getOrders(id, { limit: 5 })
                ]);

                if (customerRes.success) {
                    const customer = customerRes.data;
                    const orders = ordersRes.success ? ordersRes.data.orders : [];

                    modalBody.innerHTML = `
                        <div style="margin-bottom: 1.5rem;">
                            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                                <div style="width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, var(--primary-400), var(--primary-600)); color: white; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; font-weight: 700;">
                                    ${customer.name.charAt(0).toUpperCase()}
                                </div>
                                <div>
                                    <h2 style="margin: 0; font-size: 1.25rem;">${customer.name}</h2>
                                    <p style="margin: 0; color: var(--gray-500);">Khách hàng từ ${Utils.formatDate(customer.created_at)}</p>
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; background: var(--gray-50); padding: 1rem; border-radius: 12px;">
                                <div>
                                    <p style="color: var(--gray-500); font-size: 0.875rem; margin-bottom: 0.25rem;">Email</p>
                                    <p style="font-weight: 500; margin: 0;">${customer.email}</p>
                                </div>
                                <div>
                                    <p style="color: var(--gray-500); font-size: 0.875rem; margin-bottom: 0.25rem;">Số điện thoại</p>
                                    <p style="font-weight: 500; margin: 0;">${customer.phone || 'Chưa cập nhật'}</p>
                                </div>
                                <div>
                                    <p style="color: var(--gray-500); font-size: 0.875rem; margin-bottom: 0.25rem;">Tổng đơn hàng</p>
                                    <p style="font-weight: 600; margin: 0; color: var(--primary-600);">${customer.total_orders} đơn</p>
                                </div>
                                <div>
                                    <p style="color: var(--gray-500); font-size: 0.875rem; margin-bottom: 0.25rem;">Tổng chi tiêu</p>
                                    <p style="font-weight: 600; margin: 0; color: var(--success);">${Utils.formatCurrency(customer.total_spent)}</p>
                                </div>
                            </div>
                            
                            ${customer.address ? `
                                <div style="margin-top: 1rem; padding: 1rem; background: var(--gray-50); border-radius: 12px;">
                                    <p style="color: var(--gray-500); font-size: 0.875rem; margin-bottom: 0.25rem;">Địa chỉ</p>
                                    <p style="margin: 0;">${customer.address}</p>
                                </div>
                            ` : ''}
                        </div>

                        <div>
                            <h3 style="font-size: 1rem; margin-bottom: 1rem;">Đơn hàng gần đây</h3>
                            ${orders.length === 0 ? `
                                <p style="text-align: center; color: var(--gray-500); padding: 1rem;">Chưa có đơn hàng nào</p>
                            ` : `
                                <table class="admin-table" style="font-size: 0.875rem;">
                                    <thead>
                                        <tr>
                                            <th>Mã đơn</th>
                                            <th>Ngày đặt</th>
                                            <th>Tổng tiền</th>
                                            <th>Trạng thái</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${orders.map(order => `
                                            <tr>
                                                <td><strong>#${order.id}</strong></td>
                                                <td>${Utils.formatDate(order.created_at)}</td>
                                                <td>${Utils.formatCurrency(order.total_amount)}</td>
                                                <td><span class="status-badge ${statusLabels[order.status].class}">${statusLabels[order.status].text}</span></td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            `}
                        </div>
                    `;
                }
            } catch (error) {
                modalBody.innerHTML = '<p style="text-align: center; color: var(--danger);">Không thể tải thông tin khách hàng</p>';
            }
        }

        // Close modal
        function closeModal() {
            document.getElementById('customerModal').style.display = 'none';
        }

        // Close modal on outside click
        document.getElementById('customerModal').addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-overlay')) {
                closeModal();
            }
        });

        // Logout
        function logout() {
            API.auth.logout();
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', loadPage);
    </script>
</body>

</html>