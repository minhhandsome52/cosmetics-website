<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chi tiết sản phẩm - Mihn Cosmetics</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Outfit:wght@600;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
</head>

<body>
    <!-- Header -->
    <header class="header" id="header">
        <div class="header-container">
            <a href="index.html" class="logo">
                <span class="logo-icon"><i class="fas fa-bottle-droplet"></i></span>
                Mihn Cosmetics
            </a>
            <nav class="nav-menu">
                <a href="index.html" class="nav-link">Trang chủ</a>
                <a href="products.html" class="nav-link">Sản phẩm</a>
            </nav>
            <div class="nav-icons">
                <a href="cart.html" class="nav-icon-btn">
                    <i class="fas fa-shopping-bag"></i>
                    <span class="cart-badge">0</span>
                </a>
                <div class="auth-buttons flex gap-sm">
                    <a href="login.html" class="btn btn-outline btn-sm">Đăng nhập</a>
                </div>
                <div class="user-menu flex items-center gap-sm" style="display: none;">
                    <button class="btn btn-ghost btn-sm" onclick="API.auth.logout()">Đăng xuất</button>
                </div>
            </div>
        </div>
    </header>

    <main class="section" style="padding-top: 2rem;">
        <div class="container">
            <!-- Breadcrumb -->
            <nav style="margin-bottom: 2rem; color: var(--gray-500); font-size: 0.875rem;">
                <a href="index.html" style="color: var(--gray-500);">Trang chủ</a> /
                <a href="products.html" style="color: var(--gray-500);">Sản phẩm</a> /
                <span id="breadcrumbName" style="color: var(--gray-700);">...</span>
            </nav>

            <div id="productDetail" style="display: grid; grid-template-columns: 1fr 1fr; gap: 3rem;">
                <!-- Loading -->
                <div class="skeleton" style="aspect-ratio: 1; border-radius: 1rem;"></div>
                <div>
                    <div class="skeleton" style="height: 2rem; width: 60%; margin-bottom: 1rem;"></div>
                    <div class="skeleton" style="height: 1.5rem; width: 40%; margin-bottom: 2rem;"></div>
                    <div class="skeleton" style="height: 4rem; margin-bottom: 1rem;"></div>
                </div>
            </div>
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <div class="footer-bottom" style="border-top: none; margin-top: 0;">
                <p>&copy; 2026 Mihn Cosmetics. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <div class="toast-container"></div>

    <script src="js/api.js"></script>
    <script>
        let product = null;
        let quantity = 1;
        let currentProductId = null;

        async function loadProduct() {
            const params = new URLSearchParams(window.location.search);
            const id = params.get('id');
            currentProductId = id;

            if (!id) {
                window.location.href = 'products.html';
                return;
            }

            try {
                const response = await API.products.getById(id);
                if (response.success) {
                    product = response.data;
                    renderProduct(product);
                    document.title = `${product.name} - Mihn Cosmetics`;
                    loadReviews(id);
                }
            } catch (error) {
                document.getElementById('productDetail').innerHTML =
                    '<p style="grid-column: span 2; text-align: center; color: var(--danger);">Không tìm thấy sản phẩm</p>';
            }
        }

        function renderProduct(p) {
            document.getElementById('breadcrumbName').textContent = p.name;

            const stockClass = p.stock > 10 ? 'stock-in' : p.stock > 0 ? 'stock-low' : 'stock-out';
            const stockText = p.stock > 10 ? 'Còn hàng' : p.stock > 0 ? `Chỉ còn ${p.stock} sản phẩm` : 'Hết hàng';
            const isAvailable = p.stock > 0;

            document.getElementById('productDetail').innerHTML = `
                <div>
                    <div style="background: var(--gray-100); border-radius: 1.5rem; overflow: hidden; aspect-ratio: 1;">
                        <img src="${p.image_url || 'https://via.placeholder.com/600x600?text=Product'}" 
                             alt="${p.name}" 
                             style="width: 100%; height: 100%; object-fit: cover;">
                    </div>
                </div>

                <div>
                    <span style="color: var(--primary-500); font-weight: 600; text-transform: uppercase; letter-spacing: 1px; font-size: 0.875rem;">
                        ${p.brand}
                    </span>
                    <h1 style="font-size: 2rem; margin: 0.5rem 0 1rem;">${p.name}</h1>

                    <!-- Rating Summary -->
                    <div id="ratingsSummary" style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                        <div class="stars" style="color: #fbbf24;"></div>
                        <span style="color: var(--gray-500);">(0 đánh giá)</span>
                    </div>

                    <div class="product-stock ${stockClass}" style="margin-bottom: 1rem; font-size: 0.9375rem;">
                        <i class="fas fa-circle" style="font-size: 8px;"></i>
                        ${stockText}
                        ${p.nearest_expiry ? `<span style="color: var(--gray-400); margin-left: 0.5rem;">• HSD: ${Utils.formatDate(p.nearest_expiry)}</span>` : ''}
                    </div>

                    <div style="font-size: 2rem; font-weight: 700; color: var(--primary-600); margin-bottom: 1.5rem;">
                        ${Utils.formatCurrency(p.price)}
                    </div>

                    <p style="color: var(--gray-600); line-height: 1.7; margin-bottom: 2rem;">
                        ${p.description || 'Chưa có mô tả sản phẩm.'}
                    </p>

                    ${isAvailable ? `
                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem;">
                        <span style="font-weight: 500;">Số lượng:</span>
                        <div class="quantity-control">
                            <button onclick="changeQuantity(-1)"><i class="fas fa-minus"></i></button>
                            <span id="quantityDisplay">1</span>
                            <button onclick="changeQuantity(1)"><i class="fas fa-plus"></i></button>
                        </div>
                    </div>

                    <div style="display: flex; gap: 1rem; margin-bottom: 2rem;">
                        <button class="btn btn-primary btn-lg" style="flex: 2;" onclick="addToCart()">
                            <i class="fas fa-shopping-cart"></i>
                            Thêm vào giỏ hàng
                        </button>
                        <button class="btn btn-secondary btn-lg" onclick="buyNow()">
                            Mua ngay
                        </button>
                    </div>
                    ` : `
                    <div class="alert alert-warning" style="margin-bottom: 2rem;">
                        <i class="fas fa-exclamation-triangle"></i>
                        Sản phẩm tạm hết hàng. Vui lòng quay lại sau.
                    </div>
                    `}

                    <!-- Product Details Tabs -->
                    <div style="border-top: 1px solid var(--gray-200); padding-top: 2rem;">
                        <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                            <button class="btn btn-ghost" onclick="showTab('ingredients')" id="tabIngredients" style="border-bottom: 2px solid var(--primary-500); color: var(--primary-600);">
                                Thành phần
                            </button>
                            <button class="btn btn-ghost" onclick="showTab('usage')" id="tabUsage">
                                Hướng dẫn sử dụng
                            </button>
                        </div>

                        <div id="ingredientsContent" style="color: var(--gray-600); line-height: 1.8;">
                            ${p.ingredients || 'Thông tin đang cập nhật.'}
                        </div>
                        <div id="usageContent" style="display: none; color: var(--gray-600); line-height: 1.8;">
                            ${p.usage_instructions || 'Thông tin đang cập nhật.'}
                        </div>
                    </div>
                </div>

                <!-- Reviews Section -->
                <div style="grid-column: span 2; margin-top: 3rem; border-top: 1px solid var(--gray-200); padding-top: 2rem;">
                    <h2 style="font-size: 1.5rem; margin-bottom: 1.5rem;">
                        <i class="fas fa-star" style="color: #fbbf24;"></i> Đánh giá sản phẩm
                    </h2>

                    <!-- Write Review Form -->
                    <div id="reviewFormSection" style="background: var(--gray-50); border-radius: 1rem; padding: 1.5rem; margin-bottom: 2rem; ${Utils.isLoggedIn() ? '' : 'display: none;'}">
                        <h3 style="margin-bottom: 1rem; font-size: 1.125rem;">Viết đánh giá của bạn</h3>
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Đánh giá sao:</label>
                            <div id="starRating" style="display: flex; gap: 0.25rem; font-size: 1.5rem; cursor: pointer;">
                                <i class="far fa-star" data-rating="1" onclick="setRating(1)"></i>
                                <i class="far fa-star" data-rating="2" onclick="setRating(2)"></i>
                                <i class="far fa-star" data-rating="3" onclick="setRating(3)"></i>
                                <i class="far fa-star" data-rating="4" onclick="setRating(4)"></i>
                                <i class="far fa-star" data-rating="5" onclick="setRating(5)"></i>
                            </div>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Nhận xét:</label>
                            <textarea id="reviewComment" rows="3" style="width: 100%; padding: 0.75rem; border: 1px solid var(--gray-300); border-radius: 0.5rem; resize: vertical;" placeholder="Chia sẻ trải nghiệm của bạn về sản phẩm..."></textarea>
                        </div>
                        <button class="btn btn-primary" onclick="submitReview()">
                            <i class="fas fa-paper-plane"></i> Gửi đánh giá
                        </button>
                    </div>

                    <!-- Login prompt for non-logged-in users -->
                    <div id="loginPrompt" style="background: var(--gray-50); border-radius: 1rem; padding: 1.5rem; margin-bottom: 2rem; text-align: center; ${Utils.isLoggedIn() ? 'display: none;' : ''}">
                        <p style="margin-bottom: 1rem; color: var(--gray-600);">Đăng nhập để viết đánh giá</p>
                        <a href="login.html" class="btn btn-primary btn-sm">Đăng nhập</a>
                    </div>

                    <!-- Reviews List -->
                    <div id="reviewsList">
                        <p style="color: var(--gray-500); text-align: center;">Đang tải đánh giá...</p>
                    </div>
                </div>
            `;
        }

        let selectedRating = 0;

        function setRating(rating) {
            selectedRating = rating;
            const stars = document.querySelectorAll('#starRating i');
            stars.forEach((star, index) => {
                if (index < rating) {
                    star.classList.remove('far');
                    star.classList.add('fas');
                    star.style.color = '#fbbf24';
                } else {
                    star.classList.remove('fas');
                    star.classList.add('far');
                    star.style.color = '#9ca3af';
                }
            });
        }

        async function loadReviews(productId) {
            try {
                const response = await API.reviews.getByProduct(productId);
                if (response.success) {
                    const { reviews, avg_rating, total_reviews } = response.data;

                    // Update rating summary
                    const summaryEl = document.getElementById('ratingsSummary');
                    if (summaryEl) {
                        summaryEl.innerHTML = `
                            <div style="color: #fbbf24;">${renderStars(avg_rating)}</div>
                            <span style="font-weight: 600;">${avg_rating}</span>
                            <span style="color: var(--gray-500);">(${total_reviews} đánh giá)</span>
                        `;
                    }

                    // Render reviews list
                    renderReviewsList(reviews);
                }
            } catch (error) {
                console.error('Error loading reviews:', error);
            }
        }

        function renderStars(rating) {
            let html = '';
            for (let i = 1; i <= 5; i++) {
                if (i <= rating) {
                    html += '<i class="fas fa-star"></i>';
                } else if (i - 0.5 <= rating) {
                    html += '<i class="fas fa-star-half-alt"></i>';
                } else {
                    html += '<i class="far fa-star"></i>';
                }
            }
            return html;
        }

        function renderReviewsList(reviews) {
            const container = document.getElementById('reviewsList');

            if (reviews.length === 0) {
                container.innerHTML = '<p style="color: var(--gray-500); text-align: center; padding: 2rem;">Chưa có đánh giá nào. Hãy là người đầu tiên đánh giá!</p>';
                return;
            }

            container.innerHTML = reviews.map(review => `
                <div style="border-bottom: 1px solid var(--gray-200); padding: 1.5rem 0;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.75rem;">
                        <div>
                            <div style="font-weight: 600; margin-bottom: 0.25rem;">${review.user_name}</div>
                            <div style="color: #fbbf24; font-size: 0.875rem;">${renderStars(review.rating)}</div>
                        </div>
                        <span style="color: var(--gray-400); font-size: 0.75rem;">${Utils.formatDate(review.created_at)}</span>
                    </div>
                    <p style="color: var(--gray-600); line-height: 1.6;">${review.comment || '<em style="color: var(--gray-400);">Không có nhận xét</em>'}</p>
                </div>
            `).join('');
        }

        async function submitReview() {
            if (!Utils.isLoggedIn()) {
                Utils.showToast('Vui lòng đăng nhập để đánh giá', 'warning');
                return;
            }

            if (selectedRating === 0) {
                Utils.showToast('Vui lòng chọn số sao', 'warning');
                return;
            }

            const comment = document.getElementById('reviewComment').value.trim();

            try {
                const response = await API.reviews.create(currentProductId, selectedRating, comment);
                if (response.success) {
                    Utils.showToast('Đã gửi đánh giá thành công!', 'success');
                    document.getElementById('reviewComment').value = '';
                    setRating(0);
                    loadReviews(currentProductId);
                }
            } catch (error) {
                Utils.showToast(error.message, 'error');
            }
        }

        function showTab(tab) {
            document.getElementById('ingredientsContent').style.display = tab === 'ingredients' ? 'block' : 'none';
            document.getElementById('usageContent').style.display = tab === 'usage' ? 'block' : 'none';

            document.getElementById('tabIngredients').style.borderBottom = tab === 'ingredients' ? '2px solid var(--primary-500)' : 'none';
            document.getElementById('tabIngredients').style.color = tab === 'ingredients' ? 'var(--primary-600)' : 'var(--gray-600)';
            document.getElementById('tabUsage').style.borderBottom = tab === 'usage' ? '2px solid var(--primary-500)' : 'none';
            document.getElementById('tabUsage').style.color = tab === 'usage' ? 'var(--primary-600)' : 'var(--gray-600)';
        }

        function changeQuantity(delta) {
            const newQty = quantity + delta;
            if (newQty >= 1 && newQty <= (product?.stock || 99)) {
                quantity = newQty;
                document.getElementById('quantityDisplay').textContent = quantity;
            }
        }

        async function addToCart() {
            if (!Utils.isLoggedIn()) {
                Utils.showToast('Vui lòng đăng nhập để thêm vào giỏ hàng', 'warning');
                window.location.href = 'login.html';
                return;
            }

            try {
                const response = await API.cart.add(product.id, quantity);
                if (response.success) {
                    Utils.showToast('Đã thêm vào giỏ hàng!', 'success');
                    Utils.updateCartBadge();
                }
            } catch (error) {
                Utils.showToast(error.message, 'error');
            }
        }

        async function buyNow() {
            if (!Utils.isLoggedIn()) {
                Utils.showToast('Vui lòng đăng nhập', 'warning');
                window.location.href = 'login.html';
                return;
            }

            try {
                await API.cart.add(product.id, quantity);
                window.location.href = 'cart.html';
            } catch (error) {
                Utils.showToast(error.message, 'error');
            }
        }

        document.addEventListener('DOMContentLoaded', loadProduct);
    </script>
</body>

</html>